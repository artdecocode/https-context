{"version":3,"sources":["../src/index.js"],"names":["Socket","require","LOG","HTTPContext","constructor","called","_response","headers","state","postData","response","getState","setResponse","data","setHeaders","setContentType","contentType","_init","server","handler","bind","connections","on","con","key","remoteAddress","remotePort","Promise","resolve","listen","undefined","address","url","host","port","_destroy","Object","keys","reduce","a","c","p","r","destroy","close","req","res","writeHead","method","catchment","Catchment","pipe","promise","end"],"mappings":"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","sourcesContent":["import { createServer } from 'http'\nimport { debuglog } from 'util'\nconst { Socket } = require('net') // eslint-disable-line no-unused-vars\nimport Catchment from 'catchment'\n\nconst LOG = debuglog('https-context')\n\nexport class HTTPContext {\n  /**\n   * @constructor\n   * A Zoroaster test context that sets up an HTTP server ready for connections.\n   * @param {Config} config Configuration object.\n   * @param {string} config.type The type.\n   * @example\n   *\n   * import { equal } from 'assert'\n   * import { HTTPContext } from 'https-context'\n   * import req from '../../src'\n   * import Context from '../context'\n   *\n   * const T = {\n   *  context: [Context, HTTPContext],\n   *  async 'make request'({ readFixture }, { url }) {\n   *   const expected = await readFixture()\n   *   const r = await req(url)\n   *   equal(expected, r)\n   *  },\n   * }\n   */\n  constructor() {\n    this.called = 0\n    this._response = 'OK'\n    this.headers = {}\n\n    this.state = {\n      called: 0,\n      headers: {},\n      postData: null,\n    }\n  }\n\n  get response() {\n    return this._response\n  }\n  getState() {\n    return this.state\n  }\n  setResponse(data) {\n    this._response = data\n  }\n  setHeaders(headers) {\n    this.headers = headers\n  }\n  /**\n   * Set the content type for the response.\n   * @param {string} contentType The response content type.\n   */\n  setContentType(contentType) {\n    this.contentType = contentType\n  }\n  async _init() {\n    const server = createServer(this.handler.bind(this))\n    this.server = server\n    /** @type {Object.<string, Socket>} */\n    this.connections = {}\n\n    this.server.on('connection', (con) => {\n      const key = con.remoteAddress + ':' + con.remotePort\n      this.connections[key] = con\n      con.on('close', () => {\n        delete this.connections[key]\n      })\n    })\n    await new Promise((resolve) => {\n      this.server.listen(undefined, 'localhost', resolve)\n    })\n    this.address = server.address()\n  }\n  /** Returns address of the server\n   * @example\n   *\n   * `http://127.0.0.1:59292`\n   */\n  get url() {\n    if (!this.address) return null\n    return `http://${this.host}`\n  }\n  /** Returns host of the server\n   * @example\n   *\n   * `127.0.0.1:59292`\n   */\n  get host() {\n    if (!this.address) return null\n    return `${this.address.address}:${this.address.port}`\n  }\n  async _destroy() {\n    await new Promise(async (resolve) => {\n      await Object.keys(this.connections).reduce(async (a, key) => {\n        await a\n        const c = this.connections[key]\n        const p = new Promise((r) => {\n          c.on('close', () => {\n            LOG('socket closed')\n            r()\n          })\n        })\n        c.destroy()\n        await p\n      }, {})\n      this.server.close(resolve)\n      // this.server.on('close', resolve)\n    })\n  }\n  async handler(req, res) {\n    this.state.called += 1\n    this.state.headers = req.headers\n\n    res.writeHead(200, { 'Content-Type': this.contentType || 'text/plain', ...this.headers })\n\n    if (req.method != 'GET') {\n      const catchment = new Catchment\n      req.pipe(catchment)\n      const { promise } = catchment\n      const postData = await promise\n      this.state.postData = postData\n    }\n\n    res.end(this._response)\n  }\n}\n"],"file":"index.js"}